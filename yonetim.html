<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>QR Taksi â€“ YÃ¶netim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; }
    hr { margin: 18px 0; }
    input, select { padding: 6px; }
    button { padding: 6px 10px; cursor: pointer; }

    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 13px; }
    th { background: #f3f3f3; }

    .muted { color: #666; font-size: 12px; }
    .box { padding:10px; border:1px solid #ddd; border-radius:10px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    #loginOverlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.55);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    #loginCard {
      background: #fff; width: 320px;
      padding: 16px; border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
    }
    #app { display: none; }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <div id="loginCard">
    <h3>ğŸ” YÃ¶netim GiriÅŸi</h3>
    <div class="muted">Åifre: 1234</div><br>
    <input id="pinInput" type="password" placeholder="Åifre" style="width:100%;box-sizing:border-box;" />
    <br><br>
    <button onclick="login()">GiriÅŸ</button>
    <div id="loginMsg" class="muted" style="margin-top:10px;"></div>
  </div>
</div>

<div id="app">
  <h2>ğŸš• QR Taksi â€“ YÃ¶netim</h2>
  <div id="msgBox" class="muted"></div>

  <hr>

  <h3>1ï¸âƒ£ Taksi DuraÄŸÄ±</h3>
  <div class="row">
    <input id="stopName" placeholder="Durak adÄ±">
    <button onclick="createStop()">Ekle</button>
  </div>
  <ul id="stopList"></ul>

  <hr>

  <h3>2ï¸âƒ£ QR NoktasÄ± (Direk)</h3>

  <div class="row">
    <select id="stopSelect"></select>
  </div>

  <br>

  <div class="box">
    <b>Tek Direk Ekle</b>
    <div class="muted">Sadece baÅŸlÄ±ÄŸÄ± yaz, kod otomatik Ã¼retilir.</div>
    <br>
    <div class="row">
      <input id="pointTitle" placeholder="Direk adÄ± (Ã¶rn: AtatÃ¼rk Cd 43 No)" style="min-width:280px;">
      <button onclick="createPointSingle()">Ekle</button>
    </div>
  </div>

  <br>

  <div class="box">
    <b>AralÄ±kla Toplu Direk Ekle</b>
    <div class="muted">Ã–rn: BaÅŸlÄ±k: â€œAtatÃ¼rk Cdâ€ + 3â€“17 â†’ â€œAtatÃ¼rk Cd 3â€ ... â€œAtatÃ¼rk Cd 17â€</div>
    <br>
    <div class="row">
      <input id="rangeBaseTitle" placeholder="BaÅŸlÄ±k (Ã¶rn: AtatÃ¼rk Cd)" style="min-width:220px;">
      <input id="rangeStart" type="number" placeholder="BaÅŸlangÄ±Ã§" style="width:120px;">
      <input id="rangeEnd" type="number" placeholder="BitiÅŸ" style="width:120px;">
      <button onclick="createPointsRange()">AralÄ±ktaki Direkleri Ekle</button>
    </div>
  </div>

  <hr>

  <h3>3ï¸âƒ£ QR NoktalarÄ± Listesi</h3>
  <table>
    <thead>
      <tr>
        <th>Durak</th>
        <th>Direk</th>
        <th>Kod</th>
      </tr>
    </thead>
    <tbody id="pointTable"></tbody>
  </table>

  <hr>

  <h3>ğŸ“„ PDF indir</h3>
  <div class="muted">PDFâ€™e dahil edilecek duraÄŸÄ± seÃ§</div><br>

  <select id="pdfStopSelect">
    <option value="ALL">TÃ¼m duraklar</option>
  </select>

  <br><br>
  <button onclick="exportPDF()">A4 PDF indir</button>
  <button onclick="logout()" style="margin-left:10px;">Ã‡Ä±kÄ±ÅŸ</button>
</div>

<script>
const SUPABASE_URL = "https://cpkefhmqwrpjrwyvudky.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa2VmaG1xd3JwanJ3eXZ1ZGt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4Nzc2NjQsImV4cCI6MjA4MTQ1MzY2NH0.HhODIa99Wic-xYXa9Scg-vj7t-dERDKwskF8shfZfQk";

let stops = [];
let pickupPoints = [];

function sbHeaders(json=false){
  const h = { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` };
  if(json) h["Content-Type"]="application/json";
  return h;
}
function setMsg(t){ document.getElementById("msgBox").textContent = t || ""; }

function rand(){ return Math.random().toString(36).substring(2,7).toUpperCase(); }
function makeCodeFromTitle(title){
  const base = title.trim().toUpperCase().replace(/\s+/g,"-").substring(0,14);
  return `${base}-${rand()}`;
}

/* LOGIN */
function login(){
  const pin = document.getElementById("pinInput").value.trim();
  if(pin==="1234"){
    localStorage.setItem("qrtaxi_admin_ok","1");
    document.getElementById("loginOverlay").style.display="none";
    document.getElementById("app").style.display="block";
    init();
  } else {
    document.getElementById("loginMsg").textContent = "HatalÄ± ÅŸifre";
  }
}
function logout(){
  localStorage.removeItem("qrtaxi_admin_ok");
  location.reload();
}
(function boot(){
  if(localStorage.getItem("qrtaxi_admin_ok")==="1"){
    document.getElementById("loginOverlay").style.display="none";
    document.getElementById("app").style.display="block";
    init();
  }
})();

async function init(){
  setMsg("YÃ¼kleniyorâ€¦");
  await loadStops();
  await loadPoints();
  setMsg("");
}

/* STOPS */
async function createStop(){
  const name = document.getElementById("stopName").value.trim();
  if(!name) return alert("Durak adÄ± gerekli");

  const r = await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops`,{
    method:"POST", headers: sbHeaders(true),
    body: JSON.stringify({ name })
  });
  if(!r.ok) return alert("Durak eklenemedi");

  document.getElementById("stopName").value="";
  await loadStops();
}

async function deleteStop(stopId, stopName){
  if(!confirm(`"${stopName}" silinsin mi?\nNot: GeÃ§miÅŸ Ã§aÄŸrÄ±lar varsa hard delete engellenebilir.`)) return;

  // Hard delete dene
  const res = await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops?id=eq.${stopId}`,{
    method:"DELETE", headers: sbHeaders(false)
  });

  if(res.ok){
    setMsg(`Durak silindi: ${stopName}`);
  } else {
    // Soft delete (loglar kalsÄ±n)
    await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops?id=eq.${stopId}`,{
      method:"PATCH", headers: sbHeaders(true),
      body: JSON.stringify({ is_active:false })
    });
    await fetch(`${SUPABASE_URL}/rest/v1/pickup_points?taxi_stop_id=eq.${stopId}`,{
      method:"PATCH", headers: sbHeaders(true),
      body: JSON.stringify({ is_active:false })
    });
    setMsg(`Hard delete olmadÄ±. Durak pasifleÅŸtirildi: ${stopName}`);
  }

  await loadStops();
  await loadPoints();
}

async function loadStops(){
  const r = await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops?order=created_at.asc`,{ headers: sbHeaders(false) });
  stops = await r.json();

  // stopSelect (aktif)
  const sel = document.getElementById("stopSelect");
  sel.innerHTML = "";
  stops.filter(s => s.is_active !== false).forEach(s=>{
    sel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
  });

  // pdfStopSelect (aktif)
  const pdfSel = document.getElementById("pdfStopSelect");
  pdfSel.innerHTML = `<option value="ALL">TÃ¼m duraklar</option>`;
  stops.filter(s => s.is_active !== false).forEach(s=>{
    pdfSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
  });

  // stopList (tÃ¼mÃ¼)
  const ul = document.getElementById("stopList");
  ul.innerHTML = "";
  stops.forEach(s=>{
    const status = (s.is_active === false) ? ` <span class="muted">(pasif)</span>` : "";
    ul.innerHTML += `<li>${s.name}${status}
      <button onclick="deleteStop('${s.id}', '${(s.name||"").replaceAll("'","\\'")}')">Sil</button>
    </li>`;
  });
}

/* POINTS */
async function createPointSingle(){
  const taxi_stop_id = document.getElementById("stopSelect").value;
  const title = document.getElementById("pointTitle").value.trim();
  if(!title) return alert("Direk adÄ± gerekli");

  await createPoint(taxi_stop_id, title);
  document.getElementById("pointTitle").value="";
  await loadPoints();
}

async function createPointsRange(){
  const taxi_stop_id = document.getElementById("stopSelect").value;
  const base = document.getElementById("rangeBaseTitle").value.trim();
  const start = parseInt(document.getElementById("rangeStart").value, 10);
  const end = parseInt(document.getElementById("rangeEnd").value, 10);

  if(!base) return alert("BaÅŸlÄ±k gerekli");
  if(isNaN(start) || isNaN(end)) return alert("BaÅŸlangÄ±Ã§/BitiÅŸ sayÄ± olmalÄ±");
  if(end < start) return alert("BitiÅŸ, baÅŸlangÄ±Ã§tan kÃ¼Ã§Ã¼k olamaz");

  setMsg(`Ekleniyor: ${base} ${start}-${end} â€¦`);
  for(let i=start;i<=end;i++){
    await createPoint(taxi_stop_id, `${base} ${i}`);
  }
  setMsg(`Eklendi: ${base} ${start}-${end}`);
  await loadPoints();
}

async function createPoint(taxi_stop_id, title){
  const code = makeCodeFromTitle(title);
  const r = await fetch(`${SUPABASE_URL}/rest/v1/pickup_points`,{
    method:"POST", headers: sbHeaders(true),
    body: JSON.stringify({ taxi_stop_id, title, code, is_active:true })
  });
  if(!r.ok){
    const t = await r.text();
    alert("QR noktasÄ± eklenemedi: " + t);
  }
}

async function loadPoints(){
  const r = await fetch(
    `${SUPABASE_URL}/rest/v1/pickup_points?select=code,title,is_active,taxi_stop_id,taxi_stops(name)&order=created_at.asc`,
    { headers: sbHeaders(false) }
  );
  pickupPoints = await r.json();

  const tb = document.getElementById("pointTable");
  tb.innerHTML = "";
  pickupPoints.forEach(p=>{
    if(p.is_active === false) return;
    tb.innerHTML += `<tr>
      <td>${p.taxi_stops?.name || "-"}</td>
      <td>${p.title}</td>
      <td>${p.code}</td>
    </tr>`;
  });
}

/* ---- PDF FONT (TÃ¼rkÃ§e) ---- */
function arrayBufferToBase64(buffer){
  let binary = "";
  const bytes = new Uint8Array(buffer);
  const chunk = 0x8000;
  for(let i=0;i<bytes.length;i+=chunk){
    binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
  }
  return btoa(binary);
}

async function loadUnicodeFont(pdf){
  // âœ… Tam TTF (Google Fonts repo) â€” TÃ¼rkÃ§e karakterler dahil
  const fontUrl = "https://raw.githubusercontent.com/google/fonts/main/ofl/notosans/NotoSans-Regular.ttf";
  const res = await fetch(fontUrl);
  if(!res.ok) throw new Error("Font indirilemedi");

  const buf = await res.arrayBuffer();
  const base64 = arrayBufferToBase64(buf);

  pdf.addFileToVFS("NotoSans-Regular.ttf", base64);
  pdf.addFont("NotoSans-Regular.ttf", "NotoSans", "normal");
  pdf.setFont("NotoSans", "normal");
}

/* PDF */
async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ format:"a4", unit:"mm" });

  try {
    await loadUnicodeFont(pdf);
  } catch(e) {
    alert("TÃ¼rkÃ§e font yÃ¼klenemedi. PDF'de TÃ¼rkÃ§e bozulabilir.\n" + e.message);
  }

  const selectedStop = document.getElementById("pdfStopSelect").value;

  const listAllActive = pickupPoints.filter(p => p.is_active !== false);
  const list = (selectedStop === "ALL")
    ? listAllActive
    : listAllActive.filter(p => p.taxi_stop_id === selectedStop);

  if(!list.length){
    alert("SeÃ§ilen durakta QR noktasÄ± yok.");
    return;
  }

  const pageW = 210, pageH = 297;
  const qrSize = 40;          // 4cm
  const boxH = qrSize + 18;   // QR + yazÄ±lar
  const margin = 10;
  const gapX = 6;
  const gapY = 8;

  const maxCols = Math.floor((pageW - margin*2 + gapX) / (qrSize + gapX));
  const colW = qrSize + gapX;

  let col = 0;
  let x = margin;
  let y = margin;

  for(const p of list){
    const url = `https://ciarponec.github.io/QRtaxi/yolcu.html?code=${p.code}`;
    const img = await QRCode.toDataURL(url, { width: 300 });

    x = margin + col * colW;

    if (y + boxH > pageH - margin) {
      pdf.addPage();
      try { pdf.setFont("NotoSans","normal"); } catch {}
      y = margin;
      col = 0;
      x = margin;
    }

    // Kesme Ã§izgisi + Ã§erÃ§eve
    pdf.setLineDash([2,2]);
    pdf.rect(x, y, qrSize, boxH);
    pdf.setLineDash([]);

    // QR
    pdf.addImage(img, "PNG", x + 3, y + 3, qrSize - 6, qrSize - 6);

    // Durak adÄ±
    pdf.setFontSize(9);
    const stopName = (p.taxi_stops?.name || "").trim();
    const stopLines = pdf.splitTextToSize(stopName, qrSize);
    pdf.text(stopLines, x + qrSize/2, y + qrSize + 2, { align:"center" });

    // Direk adÄ± (bÃ¼yÃ¼k)
    pdf.setFontSize(12);
    const title = (p.title || "").trim();
    const titleLines = pdf.splitTextToSize(title, qrSize);
    pdf.text(titleLines, x + qrSize/2, y + qrSize + 8, { align:"center" });

    // yardÄ±mcÄ± yazÄ± (kÃ¼Ã§Ã¼k, sÄ±ÄŸan)
    pdf.setFontSize(7);
    const help = "Taksi Ã§aÄŸÄ±rmak iÃ§in taratÄ±n";
    const helpLines = pdf.splitTextToSize(help, qrSize);
    pdf.text(helpLines, x + qrSize/2, y + boxH - 2, { align:"center" });

    col++;
    if(col >= maxCols){
      col = 0;
      y += boxH + gapY;
    }
  }

  pdf.save("qr_taksi_a4.pdf");
}
</script>

</body>
</html>
