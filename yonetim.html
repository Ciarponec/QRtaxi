<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>QR Taksi ‚Äì Y√∂netim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 13px; }
    th { background: #f3f3f3; }
    button { margin-left: 6px; }
  </style>
</head>
<body>

<h2>üöï QR Taksi ‚Äì Y√∂netim Paneli</h2>

<hr>

<h3>1Ô∏è‚É£ Taksi Duraƒüƒ± Ekle / Sil</h3>
<input id="stopName" placeholder="Durak adƒ±">
<button onclick="createStop()">Ekle</button>

<ul id="stopList"></ul>

<hr>

<h3>2Ô∏è‚É£ QR Noktasƒ± (Direk) Ekle</h3>
<select id="stopSelect"></select><br><br>
<input id="pointTitle" placeholder="Atat√ºrk Cd 43 No">
<button onclick="createPoint()">QR Noktasƒ± Ekle</button>

<hr>

<h3>3Ô∏è‚É£ QR Noktalarƒ± Listesi</h3>
<table>
  <thead>
    <tr>
      <th>Durak</th>
      <th>Direk / Nokta</th>
      <th>Kod</th>
    </tr>
  </thead>
  <tbody id="pointTable"></tbody>
</table>

<br>
<button onclick="exportPDF()">üìÑ QR‚Äôlarƒ± A4 PDF indir</button>

<script>
const SUPABASE_URL = "https://cpkefhmqwrpjrwyvudky.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa2VmaG1xd3JwanJ3eXZ1ZGt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4Nzc2NjQsImV4cCI6MjA4MTQ1MzY2NH0.HhODIa99Wic-xYXa9Scg-vj7t-dERDKwskF8shfZfQk";

let pickupPoints = [];

function rand() {
  return Math.random().toString(36).substring(2,7).toUpperCase();
}

async function createStop() {
  const name = stopName.value.trim();
  if (!name) return alert("Durak adƒ± gerekli");

  await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops`, {
    method:"POST",
    headers:{
      apikey:SUPABASE_ANON_KEY,
      Authorization:`Bearer ${SUPABASE_ANON_KEY}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({ name })
  });

  stopName.value="";
  loadStops();
}

async function deleteStop(id) {
  if (!confirm("Bu duraƒüƒ± ve t√ºm QR noktalarƒ±nƒ± silmek istiyor musunuz?")) return;

  await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops?id=eq.${id}`, {
    method:"DELETE",
    headers:{
      apikey:SUPABASE_ANON_KEY,
      Authorization:`Bearer ${SUPABASE_ANON_KEY}`
    }
  });

  loadStops();
  loadPoints();
}

async function loadStops() {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops?order=created_at.asc`, {
    headers:{apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`}
  });
  const data = await r.json();

  stopSelect.innerHTML="";
  stopList.innerHTML="";

  data.forEach(s=>{
    stopSelect.innerHTML+=`<option value="${s.id}">${s.name}</option>`;
    stopList.innerHTML+=`<li>${s.name}
      <button onclick="deleteStop('${s.id}')">Sil</button></li>`;
  });
}

async function createPoint() {
  const taxi_stop_id = stopSelect.value;
  const title = pointTitle.value.trim();
  if (!title) return alert("Direk adƒ± gerekli");

  const code = title.replace(/\s+/g,"-").toUpperCase().substring(0,10)+"-"+rand();

  await fetch(`${SUPABASE_URL}/rest/v1/pickup_points`,{
    method:"POST",
    headers:{
      apikey:SUPABASE_ANON_KEY,
      Authorization:`Bearer ${SUPABASE_ANON_KEY}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({ taxi_stop_id, title, code })
  });

  pointTitle.value="";
  loadPoints();
}

async function loadPoints() {
  const r = await fetch(
    `${SUPABASE_URL}/rest/v1/pickup_points?select=code,title,taxi_stops(name)&order=created_at.asc`,
    {headers:{apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`}}
  );
  pickupPoints = await r.json();

  pointTable.innerHTML="";
  pickupPoints.forEach(p=>{
    pointTable.innerHTML+=`
      <tr>
        <td>${p.taxi_stops.name}</td>
        <td>${p.title}</td>
        <td>${p.code}</td>
      </tr>`;
  });
}

async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ format:"a4", unit:"mm" });

  const size = 40; // 4 cm
  const margin = 10;
  const gap = 6;

  let x = margin, y = margin;

  for (let i=0;i<pickupPoints.length;i++) {
    const p = pickupPoints[i];
    const url = `https://ciarponec.github.io/QRtaxi/yolcu.html?code=${p.code}`;
    const qr = await QRCode.toDataURL(url,{width:300});

    if (x + size > 210 - margin) {
      x = margin;
      y += size + 25;
    }
    if (y + size > 297 - margin) {
      pdf.addPage();
      x = margin;
      y = margin;
    }

    // kesme √ßizgisi
    pdf.setLineDash([2,2]);
    pdf.rect(x, y, size, size+15);
    pdf.setLineDash([]);

    pdf.addImage(qr,"PNG",x+3,y+3,size-6,size-6);

    pdf.setFontSize(10);
    pdf.text(p.taxi_stops.name, x+size/2, y+size+5, {align:"center"});

    pdf.setFontSize(12);
    pdf.text(p.title, x+size/2, y+size+10, {align:"center"});

    pdf.setFontSize(9);
    pdf.text("Taksi √ßaƒüƒ±rmak i√ßin taratƒ±n", x+size/2, y+size+14, {align:"center"});

    x += size + gap;
  }

  pdf.save("qr_taksi_a4.pdf");
}

loadStops();
loadPoints();
</script>

</body>
</html>
