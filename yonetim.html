<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>QR Taksi ‚Äì Y√∂netim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; }
    hr { margin: 18px 0; }
    input, select { padding: 6px; }
    button { padding: 6px 10px; cursor: pointer; }

    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 13px; }
    th { background: #f3f3f3; }

    .muted { color: #666; font-size: 12px; }
    .box { padding:10px; border:1px solid #ddd; border-radius:10px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    #loginOverlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.55);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    #loginCard {
      background: #fff; width: 320px;
      padding: 16px; border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
    }
    #app { display: none; }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <div id="loginCard">
    <h3>üîê Y√∂netim Giri≈üi</h3>
    <div class="muted">≈ûifre: 1234</div><br>
    <input id="pinInput" type="password" placeholder="≈ûifre" style="width:100%;" />
    <br><br>
    <button onclick="login()">Giri≈ü</button>
    <div id="loginMsg" class="muted"></div>
  </div>
</div>

<div id="app">
  <h2>üöï QR Taksi ‚Äì Y√∂netim</h2>

  <hr>

  <!-- 1 -->
  <h3>1Ô∏è‚É£ Taksi Duraƒüƒ±</h3>
  <div class="row">
    <input id="stopName" placeholder="Durak adƒ±">
    <button onclick="createStop()">Ekle</button>
  </div>
  <ul id="stopList"></ul>

  <hr>

  <!-- 2 -->
  <h3>2Ô∏è‚É£ QR Noktasƒ± (Direk)</h3>

  <select id="stopSelect"></select>
  <br><br>

  <div class="box">
    <b>Tek Direk</b>
    <div class="row">
      <input id="pointTitle" placeholder="Direk adƒ± (√∂rn: Atat√ºrk Cd 43)" style="min-width:260px;">
      <button onclick="createPointSingle()">Ekle</button>
    </div>
  </div>

  <br>

  <div class="box">
    <b>Aralƒ±kla Toplu Direk</b>
    <div class="muted">√ñrn: ‚ÄúAtat√ºrk Cd‚Äù + 3‚Äì17</div>
    <br>
    <div class="row">
      <input id="rangeBaseTitle" placeholder="Ba≈ülƒ±k (√∂rn: Atat√ºrk Cd)" style="min-width:200px;">
      <input id="rangeStart" type="number" placeholder="Ba≈ülangƒ±√ß">
      <input id="rangeEnd" type="number" placeholder="Biti≈ü">
      <button onclick="createPointsRange()">Toplu Ekle</button>
    </div>
  </div>

  <hr>

  <!-- 3 -->
  <h3>3Ô∏è‚É£ QR Noktalarƒ±</h3>
  <table>
    <thead>
      <tr>
        <th>Durak</th>
        <th>Direk</th>
        <th>Kod</th>
      </tr>
    </thead>
    <tbody id="pointTable"></tbody>
  </table>

  <hr>

  <!-- PDF -->
  <h3>üìÑ PDF indir</h3>
  <div class="muted">PDF‚Äôe dahil edilecek duraƒüƒ± se√ß</div><br>
  <select id="pdfStopSelect">
    <option value="ALL">T√ºm duraklar</option>
  </select>
  <br><br>
  <button onclick="exportPDF()">A4 PDF indir</button>
  <button onclick="logout()">√áƒ±kƒ±≈ü</button>
</div>

<script>
const SUPABASE_URL = "https://cpkefhmqwrpjrwyvudky.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa2VmaG1xd3JwanJ3eXZ1ZGt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4Nzc2NjQsImV4cCI6MjA4MTQ1MzY2NH0.HhODIa99Wic-xYXa9Scg-vj7t-dERDKwskF8shfZfQk";

let stops = [];
let pickupPoints = [];

function headers(json=false){
  const h={apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`};
  if(json) h["Content-Type"]="application/json";
  return h;
}
function rand(){return Math.random().toString(36).substring(2,7).toUpperCase();}
function makeCode(t){return t.toUpperCase().replace(/\s+/g,"-").slice(0,12)+"-"+rand();}

/* LOGIN */
function login(){
  if(pinInput.value==="1234"){
    localStorage.setItem("admin","1");
    loginOverlay.style.display="none";
    app.style.display="block";
    init();
  } else loginMsg.innerText="Hatalƒ± ≈üifre";
}
function logout(){localStorage.clear();location.reload();}
if(localStorage.getItem("admin")==="1"){loginOverlay.style.display="none";app.style.display="block";init();}

/* INIT */
async function init(){await loadStops();await loadPoints();}

/* STOPS */
async function createStop(){
  if(!stopName.value) return;
  await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops`,{
    method:"POST",headers:headers(true),
    body:JSON.stringify({name:stopName.value})
  });
  stopName.value="";
  loadStops();
}
async function loadStops(){
  const r=await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops?order=created_at.asc`,{headers:headers()});
  stops=await r.json();
  stopSelect.innerHTML="";
  pdfStopSelect.innerHTML=`<option value="ALL">T√ºm duraklar</option>`;
  stopList.innerHTML="";
  stops.forEach(s=>{
    stopSelect.innerHTML+=`<option value="${s.id}">${s.name}</option>`;
    pdfStopSelect.innerHTML+=`<option value="${s.id}">${s.name}</option>`;
    stopList.innerHTML+=`<li>${s.name}</li>`;
  });
}

/* POINTS */
async function createPointSingle(){
  if(!pointTitle.value) return;
  await createPoint(stopSelect.value, pointTitle.value);
  pointTitle.value="";
  loadPoints();
}
async function createPointsRange(){
  const base=rangeBaseTitle.value;
  const s=parseInt(rangeStart.value), e=parseInt(rangeEnd.value);
  if(!base||isNaN(s)||isNaN(e)||e<s) return alert("Aralƒ±k hatalƒ±");
  for(let i=s;i<=e;i++) await createPoint(stopSelect.value,`${base} ${i}`);
  loadPoints();
}
async function createPoint(stopId,title){
  await fetch(`${SUPABASE_URL}/rest/v1/pickup_points`,{
    method:"POST",headers:headers(true),
    body:JSON.stringify({taxi_stop_id:stopId,title,code:makeCode(title)})
  });
}
async function loadPoints(){
  const r=await fetch(`${SUPABASE_URL}/rest/v1/pickup_points?select=code,title,taxi_stop_id,taxi_stops(name)`,{headers:headers()});
  pickupPoints=await r.json();
  pointTable.innerHTML="";
  pickupPoints.forEach(p=>{
    pointTable.innerHTML+=`<tr><td>${p.taxi_stops.name}</td><td>${p.title}</td><td>${p.code}</td></tr>`;
  });
}

/* FONT */
function ab2b64(buf){
  let b="";new Uint8Array(buf).forEach(x=>b+=String.fromCharCode(x));
  return btoa(b);
}
async function loadFont(pdf){
  const r=await fetch("./fonts/NotoSans-Regular.ttf");
  const buf=await r.arrayBuffer();
  pdf.addFileToVFS("NotoSans.ttf",ab2b64(buf));
  pdf.addFont("NotoSans.ttf","Noto","normal");
  pdf.setFont("Noto");
}

/* PDF */
async function exportPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({format:"a4",unit:"mm"});
  await loadFont(pdf);

  const sel=pdfStopSelect.value;
  const list=sel==="ALL"?pickupPoints:pickupPoints.filter(p=>p.taxi_stop_id===sel);

  let x=10,y=30,col=0;
  const size=40,box=size+22,gx=6,gy=8,w=210,h=297;
  let curStop=null;

  for(const p of list){
    if(p.taxi_stops.name!==curStop){
      if(curStop) pdf.addPage();
      curStop=p.taxi_stops.name;
      pdf.setFontSize(18);
      pdf.text(curStop,w/2,18,{align:"center"});
      x=10;y=30;col=0;
    }
    if(x+size>w-10){x=10;y+=box+gy;}
    if(y+box>h-10){pdf.addPage();pdf.text(curStop,w/2,18,{align:"center"});x=10;y=30;}

    const img=await QRCode.toDataURL(`https://ciarponec.github.io/QRtaxi/yolcu.html?code=${p.code}`);
    pdf.setLineDash([2,2]);pdf.rect(x,y,size,box);pdf.setLineDash([]);
    pdf.addImage(img,"PNG",x+3,y+3,size-6,size-6);

    pdf.setFontSize(9);
    pdf.text(curStop,x+size/2,y+size+3,{align:"center"});
    pdf.setFontSize(12);
    pdf.text(p.title,x+size/2,y+size+10,{align:"center"});
    pdf.setFontSize(7);
    pdf.text(["Taksi √ßaƒüƒ±rmak i√ßin","taratƒ±n"],x+size/2,y+box-3,{align:"center"});

    x+=size+gx;
  }
  pdf.save("qr_taksi_a4.pdf");
}
</script>
</body>
</html>
