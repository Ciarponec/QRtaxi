<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>QR Taksi ‚Äì Y√∂netim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; }
    hr { margin: 18px 0; }
    input, select { padding: 6px; }
    button { padding: 6px 10px; cursor: pointer; }

    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 13px; }
    th { background: #f3f3f3; }

    .muted { color: #666; font-size: 12px; }

    #loginOverlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.55);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    #loginCard {
      background: #fff; width: 320px;
      padding: 16px; border-radius: 12px;
    }
    #app { display: none; }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <div id="loginCard">
    <h3>üîê Y√∂netim Giri≈üi</h3>
    <div class="muted">≈ûifre: 1234</div><br>
    <input id="pinInput" type="password" placeholder="≈ûifre" />
    <br><br>
    <button onclick="login()">Giri≈ü</button>
    <div id="loginMsg" class="muted"></div>
  </div>
</div>

<div id="app">
  <h2>üöï QR Taksi ‚Äì Y√∂netim</h2>

  <hr>

  <h3>1Ô∏è‚É£ Taksi Duraƒüƒ±</h3>
  <input id="stopName" placeholder="Durak adƒ±">
  <button onclick="createStop()">Ekle</button>
  <ul id="stopList"></ul>

  <hr>

  <h3>2Ô∏è‚É£ QR Noktasƒ± (Direk)</h3>
  <select id="stopSelect"></select><br><br>
  <input id="pointTitle" placeholder="Direk adƒ± (√∂rn: Atat√ºrk Cd 43 No)">
  <button onclick="createPointSingle()">Ekle</button>

  <hr>

  <h3>3Ô∏è‚É£ QR Noktalarƒ±</h3>
  <table>
    <thead>
      <tr>
        <th>Durak</th>
        <th>Direk</th>
        <th>Kod</th>
      </tr>
    </thead>
    <tbody id="pointTable"></tbody>
  </table>

  <hr>

  <h3>üìÑ PDF ƒ∞ndir</h3>
  <div class="muted">PDF‚Äôe dahil edilecek duraƒüƒ± se√ß</div><br>

  <select id="pdfStopSelect">
    <option value="ALL">T√ºm duraklar</option>
  </select>

  <br><br>
  <button onclick="exportPDF()">A4 PDF indir</button>
  <button onclick="logout()" style="margin-left:10px;">√áƒ±kƒ±≈ü</button>
</div>

<script>
const SUPABASE_URL = "https://cpkefhmqwrpjrwyvudky.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa2VmaG1xd3JwanJ3eXZ1ZGt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4Nzc2NjQsImV4cCI6MjA4MTQ1MzY2NH0.HhODIa99Wic-xYXa9Scg-vj7t-dERDKwskF8shfZfQk";

let stops = [];
let pickupPoints = [];

/* LOGIN */
function login(){
  if(pinInput.value==="1234"){
    localStorage.setItem("qrtaxi_admin","1");
    loginOverlay.style.display="none";
    app.style.display="block";
    init();
  } else {
    loginMsg.innerText="Hatalƒ± ≈üifre";
  }
}
function logout(){
  localStorage.removeItem("qrtaxi_admin");
  location.reload();
}
if(localStorage.getItem("qrtaxi_admin")==="1"){
  loginOverlay.style.display="none";
  app.style.display="block";
  init();
}

/* HELPERS */
function sbHeaders(json=false){
  const h={apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`};
  if(json) h["Content-Type"]="application/json";
  return h;
}
function rand(){return Math.random().toString(36).substring(2,7).toUpperCase();}
function makeCode(title){
  return title.toUpperCase().replace(/\s+/g,"-").substring(0,12)+"-"+rand();
}

/* INIT */
async function init(){
  await loadStops();
  await loadPoints();
}

/* STOPS */
async function createStop(){
  if(!stopName.value.trim()) return;
  await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops`,{
    method:"POST",headers:sbHeaders(true),
    body:JSON.stringify({name:stopName.value.trim()})
  });
  stopName.value="";
  loadStops();
}
async function loadStops(){
  const r=await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops?order=created_at.asc`,{headers:sbHeaders()});
  stops=await r.json();

  stopSelect.innerHTML="";
  pdfStopSelect.innerHTML=`<option value="ALL">T√ºm duraklar</option>`;
  stopList.innerHTML="";

  stops.forEach(s=>{
    stopSelect.innerHTML+=`<option value="${s.id}">${s.name}</option>`;
    pdfStopSelect.innerHTML+=`<option value="${s.id}">${s.name}</option>`;
    stopList.innerHTML+=`<li>${s.name}</li>`;
  });
}

/* POINTS */
async function createPointSingle(){
  if(!pointTitle.value.trim()) return;
  await fetch(`${SUPABASE_URL}/rest/v1/pickup_points`,{
    method:"POST",headers:sbHeaders(true),
    body:JSON.stringify({
      taxi_stop_id:stopSelect.value,
      title:pointTitle.value.trim(),
      code:makeCode(pointTitle.value)
    })
  });
  pointTitle.value="";
  loadPoints();
}
async function loadPoints(){
  const r=await fetch(
    `${SUPABASE_URL}/rest/v1/pickup_points?select=code,title,taxi_stop_id,taxi_stops(name)&order=created_at.asc`,
    {headers:sbHeaders()}
  );
  pickupPoints=await r.json();

  pointTable.innerHTML="";
  pickupPoints.forEach(p=>{
    pointTable.innerHTML+=`
      <tr>
        <td>${p.taxi_stops.name}</td>
        <td>${p.title}</td>
        <td>${p.code}</td>
      </tr>`;
  });
}

/* PDF */
async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({format:"a4",unit:"mm"});

  const selectedStop = pdfStopSelect.value;
  const list = selectedStop==="ALL"
    ? pickupPoints
    : pickupPoints.filter(p=>p.taxi_stop_id===selectedStop);

  let x=10,y=10,col=0;
  const size=40, gap=6, pageW=210;

  for(const p of list){
    const qr=await QRCode.toDataURL(
      `https://ciarponec.github.io/QRtaxi/yolcu.html?code=${p.code}`
    );

    x = 10 + col*(size+gap);
    if(x+size>pageW-10){ col=0; y+=60; x=10; }
    if(y+60>287){ pdf.addPage(); y=10; }

    pdf.setLineDash([2,2]);
    pdf.rect(x,y,size,size+18);
    pdf.setLineDash([]);

    pdf.addImage(qr,"PNG",x+3,y+3,size-6,size-6);

    pdf.setFontSize(9);
    pdf.text(p.taxi_stops.name,x+size/2,y+size+5,{align:"center"});
    pdf.setFontSize(12);
    pdf.text(p.title,x+size/2,y+size+11,{align:"center"});
    pdf.setFontSize(7);
    pdf.text("Taksi √ßaƒüƒ±rmak i√ßin taratƒ±n",x+size/2,y+size+16,{align:"center"});

    col++;
  }

  pdf.save("qr_taksi_a4.pdf");
}
</script>

</body>
</html>
