<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>QR Taksi â€“ YÃ¶netim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- QR + PDF -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
    }
    .qr-card {
      border: 1px solid #333;
      padding: 6px;
      text-align: center;
      font-size: 12px;
    }
    .qr-card canvas {
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>

<h2>ğŸš• QR Taksi â€“ YÃ¶netim</h2>

<hr>

<h3>1ï¸âƒ£ Taksi DuraÄŸÄ± Ekle</h3>
<input id="stopName" placeholder="Durak adÄ±">
<button onclick="createStop()">Ekle</button>

<hr>

<h3>2ï¸âƒ£ QR NoktasÄ± (Direk) Ekle</h3>
<select id="stopSelect"></select><br><br>
<input id="pointTitle" placeholder="AtatÃ¼rk Cd 43 No">
<button onclick="createPoint()">QR NoktasÄ± Ekle</button>

<hr>

<h3>3ï¸âƒ£ QR Kodlar</h3>
<div id="qrList" class="grid"></div>
<br>
<button onclick="exportPDF()">ğŸ“„ QRâ€™larÄ± A4 PDF indir</button>

<script>
const SUPABASE_URL = "https://cpkefhmqwrpjrwyvudky.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa2VmaG1xd3JwanJ3eXZ1ZGt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4Nzc2NjQsImV4cCI6MjA4MTQ1MzY2NH0.HhODIa99Wic-xYXa9Scg-vj7t-dERDKwskF8shfZfQk";

let pickupPoints = [];

function slug() {
  return Math.random().toString(36).substring(2, 7).toUpperCase();
}

async function createStop() {
  const name = document.getElementById("stopName").value.trim();
  if (!name) return alert("Durak adÄ± gerekli");

  await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ name })
  });

  document.getElementById("stopName").value = "";
  loadStops();
}

async function loadStops() {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops?order=created_at.asc`, {
    headers: { apikey: SUPABASE_ANON_KEY, Authorization:`Bearer ${SUPABASE_ANON_KEY}` }
  });
  const data = await r.json();
  const sel = document.getElementById("stopSelect");
  sel.innerHTML = "";
  data.forEach(s => {
    sel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
  });
}

async function createPoint() {
  const taxi_stop_id = document.getElementById("stopSelect").value;
  const title = document.getElementById("pointTitle").value.trim();
  if (!title) return alert("BaÅŸlÄ±k gerekli");

  const code = title.replace(/\s+/g,"-").toUpperCase().substring(0,10) + "-" + slug();

  await fetch(`${SUPABASE_URL}/rest/v1/pickup_points`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ taxi_stop_id, title, code })
  });

  document.getElementById("pointTitle").value = "";
  loadPoints();
}

async function loadPoints() {
  const r = await fetch(
    `${SUPABASE_URL}/rest/v1/pickup_points?select=code,title,taxi_stops(name)&order=created_at.desc`,
    { headers:{apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`} }
  );
  pickupPoints = await r.json();
  renderQRs();
}

function renderQRs() {
  const div = document.getElementById("qrList");
  div.innerHTML = "";

  pickupPoints.forEach(p => {
    const url = `https://ciarponec.github.io/QRtaxi/yolcu.html?code=${p.code}`;
    const card = document.createElement("div");
    card.className = "qr-card";

    const canvas = document.createElement("canvas");
    QRCode.toCanvas(canvas, url, { width: 120 });

    card.appendChild(canvas);
    card.innerHTML += `<b>${p.title}</b><br><small>${p.taxi_stops.name}</small>`;
    div.appendChild(card);
  });
}

async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ format: "a4", unit: "mm" });

  const qrSize = 40; // 4 cm
  const margin = 10;
  const gap = 5;

  let x = margin;
  let y = margin;

  for (let i = 0; i < pickupPoints.length; i++) {
    const p = pickupPoints[i];
    const url = `https://ciarponec.github.io/QRtaxi/yolcu.html?code=${p.code}`;
    const img = await QRCode.toDataURL(url, { width: 300 });

    if (x + qrSize > 210 - margin) {
      x = margin;
      y += qrSize + 15;
    }
    if (y + qrSize > 297 - margin) {
      pdf.addPage();
      x = margin;
      y = margin;
    }

    pdf.rect(x, y, qrSize, qrSize);
    pdf.addImage(img, "PNG", x + 2, y + 2, qrSize - 4, qrSize - 4);
    pdf.text("Taksi Ã§aÄŸÄ±rmak iÃ§in taratÄ±n", x, y + qrSize + 5, { maxWidth: qrSize });

    x += qrSize + gap;
  }

  pdf.save("qr_taksi_a4.pdf");
}

loadStops();
loadPoints();
</script>

</body>
</html>
