<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>QR Taksi ‚Äì Y√∂netim</title>

<link href="./fonts/NotoSans-Regular.ttf" rel="preload" as="font" type="font/ttf" crossorigin>

<style>
body{
  margin:0;
  font-family:'Noto Sans', system-ui, sans-serif;
  background:#f4f5f7;
}
.container{
  max-width:900px;
  margin:30px auto;
  background:#fff;
  border-radius:16px;
  padding:24px;
  box-shadow:0 12px 30px rgba(0,0,0,.12);
}
h1{margin:0 0 20px}
h2{margin:24px 0 10px;font-size:18px}
input,select,button{
  padding:10px;
  font-size:14px;
}
button{
  border:0;
  border-radius:10px;
  cursor:pointer;
}
.primary{background:#111;color:#fff}
.secondary{background:#eee}
.danger{background:#e53935;color:#fff}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.list{margin-top:10px}
.item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  border-bottom:1px solid #eee;
}
small{color:#666}
</style>
</head>

<body>
<div class="container">

<h1>üöï QR Taksi ‚Äì Y√∂netim</h1>

<!-- 1. TAKSƒ∞ DURAKLARI -->
<h2>1Ô∏è‚É£ Taksi Duraklarƒ±</h2>
<div class="row">
  <input id="stopName" placeholder="Durak adƒ±">
  <button class="primary" onclick="addStop()">Ekle</button>
</div>
<div id="stopList" class="list"></div>

<!-- 2. LOKASYONLAR -->
<h2>2Ô∏è‚É£ Lokasyonlar</h2>
<div class="row">
  <select id="stopSelect"></select>
</div>

<h3>Tek lokasyon ekle</h3>
<div class="row">
  <input id="locationTitle" placeholder="Lokasyon adƒ± (√∂rn. Atat√ºrk Cd)">
  <button class="primary" onclick="addLocation()">Ekle</button>
</div>

<h3>Aralƒ±kla lokasyon ekle</h3>
<div class="row">
  <input id="rangeStart" type="number" placeholder="Ba≈ülangƒ±√ß no">
  <input id="rangeEnd" type="number" placeholder="Biti≈ü no">
  <button class="primary" onclick="addRange()">Aralƒ±ƒüƒ± Ekle</button>
</div>

<!-- 3. PDF -->
<h2>3Ô∏è‚É£ PDF Olu≈ütur</h2>
<div class="row">
  <select id="pdfStopSelect"></select>
  <button class="primary" onclick="downloadPDF()">A4 PDF indir</button>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
const SUPABASE_URL="https://cpkefhmqwrpjrwyvudky.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa2VmaG1xd3JwanJ3eXZ1ZGt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4Nzc2NjQsImV4cCI6MjA4MTQ1MzY2NH0.HhODIa99Wic-xYXa9Scg-vj7t-dERDKwskF8shfZfQk";

const headers=()=>({
  apikey:SUPABASE_ANON_KEY,
  Authorization:"Bearer "+SUPABASE_ANON_KEY,
  "Content-Type":"application/json"
});

async function loadStops(){
  const r=await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops?select=id,name,is_active&order=created_at`,{headers:headers()});
  const stops=await r.json();

  const list=document.getElementById("stopList");
  const sel=document.getElementById("stopSelect");
  const pdfSel=document.getElementById("pdfStopSelect");
  list.innerHTML=sel.innerHTML=pdfSel.innerHTML="";

  stops.forEach(s=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`
      <div>
        <b>${s.name}</b>
        <small>${s.is_active?"aktif":"pasif"}</small>
      </div>
      <div class="row">
        <button class="secondary" onclick="toggleStop('${s.id}',${!s.is_active})">${s.is_active?"Pasifle≈ütir":"Aktifle≈ütir"}</button>
        <button class="danger" onclick="deleteStop('${s.id}')">Sil</button>
      </div>`;
    list.appendChild(div);

    if(s.is_active){
      sel.innerHTML+=`<option value="${s.id}">${s.name}</option>`;
      pdfSel.innerHTML+=`<option value="${s.id}">${s.name}</option>`;
    }
  });
}

async function addStop(){
  const name=document.getElementById("stopName").value.trim();
  if(!name)return alert("Durak adƒ± gir");
  await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops`,{
    method:"POST",headers:headers(),
    body:JSON.stringify({name,is_active:true})
  });
  document.getElementById("stopName").value="";
  loadStops();
}

async function toggleStop(id,val){
  await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops?id=eq.${id}`,{
    method:"PATCH",headers:headers(),
    body:JSON.stringify({is_active:val})
  });
  loadStops();
}

async function deleteStop(id){
  if(!confirm("Bu duraƒüƒ± silmek istiyor musun?"))return;
  const r=await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops?id=eq.${id}`,{
    method:"DELETE",headers:headers()
  });
  if(!r.ok)alert("Bu duraƒüa baƒülƒ± lokasyonlar var.");
  loadStops();
}

async function addLocation(){
  const stop=document.getElementById("stopSelect").value;
  const title=document.getElementById("locationTitle").value.trim();
  if(!title)return alert("Lokasyon adƒ± gir");
  const code=Math.floor(1000+Math.random()*9000).toString();
  await fetch(`${SUPABASE_URL}/rest/v1/pickup_points`,{
    method:"POST",headers:headers(),
    body:JSON.stringify({taxi_stop_id:stop,title,code})
  });
  document.getElementById("locationTitle").value="";
}

async function addRange(){
  const stop=document.getElementById("stopSelect").value;
  const s=parseInt(rangeStart.value),e=parseInt(rangeEnd.value);
  if(!s||!e||s>e)return alert("Aralƒ±k hatalƒ±");
  const rows=[];
  for(let i=s;i<=e;i++){
    rows.push({taxi_stop_id:stop,title:"Lokasyon "+i,code:i.toString()});
  }
  await fetch(`${SUPABASE_URL}/rest/v1/pickup_points`,{
    method:"POST",headers:headers(),body:JSON.stringify(rows)
  });
}

async function downloadPDF(){
  const stopId=document.getElementById("pdfStopSelect").value;
  const r=await fetch(`${SUPABASE_URL}/rest/v1/pickup_points?taxi_stop_id=eq.${stopId}&select=title,code,taxi_stops(name)`,{headers:headers()});
  const rows=await r.json();

  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({unit:"mm",format:"a4"});
  let x=10,y=20;

  rows.forEach((p,i)=>{
    if(i%4===0&&i>0){pdf.addPage();x=10;y=20}
    pdf.setFontSize(16);
    pdf.text("TAKSƒ∞ √áAƒûIRMAK ƒ∞√áƒ∞N TARATIN",105,y,{align:"center"});
    y+=8;

    const url=`${location.origin}/yolcu.html?location=${p.code}`;
    const qr=pdf.addImage(QRCode.toDataURL(url,{margin:0}),"PNG",x,y,40,40);

    y+=42;
    pdf.setFontSize(10);
    pdf.text(p.taxi_stops.name,x+20,y,{align:"center"});
    y+=6;
    pdf.text("Lokasyon "+p.code,x+20,y,{align:"center"});
    y+=20;
  });

  pdf.save("qr-taksi.pdf");
}

loadStops();
</script>

</body>
</html>
