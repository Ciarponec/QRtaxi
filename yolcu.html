<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Taksi √áaƒüƒ±r</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>

<h2>üöï Taksi √áaƒüƒ±r</h2>
<div id="pointInfo"></div>

<div id="createBox">
  <p>Telefon numaranƒ±z yalnƒ±zca bu √ßaƒürƒ± i√ßin payla≈üƒ±lƒ±r.</p>
  <input id="phone" type="tel" placeholder="05xxxxxxxxx" style="width:100%;padding:8px;font-size:16px;">
  <br><br>
  <button onclick="createRequest()">Taksi √áaƒüƒ±r</button>
</div>

<div id="statusBox" style="margin-top:20px;"></div>
<button id="cancelBtn" onclick="cancelByUser()" style="display:none;">‚ùå ƒ∞ptal Et</button>

<script>
const SUPABASE_URL = "https://cpkefhmqwrpjrwyvudky.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa2VmaG1xd3JwanJ3eXZ1ZGt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4Nzc2NjQsImV4cCI6MjA4MTQ1MzY2NH0.HhODIa99Wic-xYXa9Scg-vj7t-dERDKwskF8shfZfQk";

const params = new URLSearchParams(window.location.search);
const CODE = params.get("code");

let pickupPoint = null;
let requestId = null;
let poller = null;

function fmt(ts) {
  return new Date(ts).toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});
}

async function loadPickupPoint() {
  const r = await fetch(
    `${SUPABASE_URL}/rest/v1/pickup_points?code=eq.${CODE}&select=id,title,taxi_stop_id`,
    { headers:{apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`} }
  );
  const d = await r.json();
  if (!d.length) {
    document.body.innerHTML = "‚ùå Ge√ßersiz QR";
    return;
  }
  pickupPoint = d[0];
  document.getElementById("pointInfo").innerHTML =
    `<b>üìç ${pickupPoint.title}</b>`;
}

async function createRequest() {
  const phone = document.getElementById("phone").value.trim();
  if (!phone) return alert("Telefon gerekli");

  const r = await fetch(`${SUPABASE_URL}/rest/v1/ride_requests`, {
    method:"POST",
    headers:{
      apikey:SUPABASE_ANON_KEY,
      Authorization:`Bearer ${SUPABASE_ANON_KEY}`,
      "Content-Type":"application/json",
      Prefer:"return=representation"
    },
    body:JSON.stringify({
      pickup_point_id: pickupPoint.id,
      phone,
      status:"waiting"
    })
  });
  const d = await r.json();
  requestId = d[0].id;

  document.getElementById("createBox").style.display="none";
  document.getElementById("cancelBtn").style.display="block";

  pollStatus();
  poller = setInterval(pollStatus,5000);
}

async function pollStatus() {
  const r = await fetch(
    `${SUPABASE_URL}/rest/v1/ride_requests?id=eq.${requestId}`,
    { headers:{apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`} }
  );
  const d = await r.json();
  if (!d.length) return;

  const x = d[0];
  const box = document.getElementById("statusBox");

  if (x.status==="waiting") box.innerText="‚è≥ Taksi bekleniyor";
  if (x.status==="accepted") box.innerText=`üöï Taksi yolda ‚Äì ${x.eta_minutes} dk`;
  if (x.status==="cancelled_by_taxi")
    box.innerText=`‚ö†Ô∏è Taksi iptal etti (${fmt(x.cancelled_at)}), tekrar aranƒ±yor`;
  if (x.status==="cancelled_by_user") {
    box.innerText=`‚ùå √áaƒürƒ± iptal edildi (${fmt(x.cancelled_at)})`;
    clearInterval(poller);
  }
}

async function cancelByUser() {
  if (!confirm("√áaƒürƒ± iptal edilsin mi?")) return;
  await fetch(
    `${SUPABASE_URL}/rest/v1/ride_requests?id=eq.${requestId}`,
    {
      method:"PATCH",
      headers:{
        apikey:SUPABASE_ANON_KEY,
        Authorization:`Bearer ${SUPABASE_ANON_KEY}`,
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        status:"cancelled_by_user",
        cancelled_by:"user",
        cancelled_at:new Date().toISOString()
      })
    }
  );
}

loadPickupPoint();
</script>
</body>
</html>
