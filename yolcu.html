<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Taksi Ã‡aÄŸÄ±r</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>

<h2>ğŸš• Taksi Ã‡aÄŸÄ±r</h2>

<div id="stepCreate">
  <p>
    Telefon numaranÄ±z yalnÄ±zca bu Ã§aÄŸrÄ± iÃ§in taksiyle paylaÅŸÄ±lÄ±r.
  </p>
  <input
    type="tel"
    id="phone"
    placeholder="05xxxxxxxxx"
    style="font-size:18px; padding:8px; width:100%;"
  />
  <br><br>
  <button onclick="createRequest()" style="font-size:18px;">
    Taksi Ã‡aÄŸÄ±r
  </button>
</div>

<div id="statusBox" style="display:none; margin-top:20px;"></div>

<button
  id="cancelBtn"
  onclick="cancelByUser()"
  style="display:none; margin-top:10px;"
>
  âŒ Ä°ptal Et
</button>

<script>
const SUPABASE_URL = "https://cpkefhmqwrpjrwyvudky.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa2VmaG1xd3JwanJ3eXZ1ZGt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4Nzc2NjQsImV4cCI6MjA4MTQ1MzY2NH0.HhODIa99Wic-xYXa9Scg-vj7t-dERDKwskF8shfZfQk";

const params = new URLSearchParams(window.location.search);
const LOCATION_ID = params.get("loc") || "unknown";
const LOCATION_TITLE = LOCATION_ID;

let requestId = null;
let poller = null;

function createRequest() {
  const phone = document.getElementById("phone").value.trim();
  if (!phone) {
    alert("Telefon numarasÄ± gerekli");
    return;
  }

  if (!confirm(`Taksi Ã§aÄŸrÄ±sÄ± gÃ¶nderilecek.\nTelefon: ${phone}`)) return;

  fetch(`${SUPABASE_URL}/rest/v1/ride_requests`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      "Content-Type": "application/json",
      Prefer: "return=representation"
    },
    body: JSON.stringify({
      phone,
      location_id: LOCATION_ID,
      location_title: LOCATION_TITLE,
      status: "waiting"
    })
  })
  .then(r => r.json())
  .then(d => {
    requestId = d[0].id;
    document.getElementById("stepCreate").style.display = "none";
    document.getElementById("statusBox").style.display = "block";
    document.getElementById("cancelBtn").style.display = "block";
    pollStatus();
    poller = setInterval(pollStatus, 5000);
  });
}

function pollStatus() {
  fetch(`${SUPABASE_URL}/rest/v1/ride_requests?id=eq.${requestId}`, {
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`
    }
  })
  .then(r => r.json())
  .then(d => {
    if (!d.length) return;
    const r = d[0];
    const box = document.getElementById("statusBox");

    if (r.status === "waiting") {
      box.innerText = "â³ Taksi bekleniyor";
    }

    if (r.status === "accepted") {
      box.innerText = `ğŸš• Taksi yolda â€“ ${r.eta_minutes} dk`;
    }

    if (r.status === "cancelled_by_taxi") {
      box.innerText = "âš ï¸ Taksi iptal etti, tekrar taksi aranÄ±yor";
    }

    if (r.status === "cancelled_by_user") {
      box.innerText = "âŒ Ã‡aÄŸrÄ± iptal edildi";
      document.getElementById("cancelBtn").style.display = "none";
      clearInterval(poller);
    }
  });
}

function cancelByUser() {
  if (!confirm("Taksi Ã§aÄŸrÄ±sÄ±nÄ± iptal etmek istiyor musunuz?")) return;

  fetch(`${SUPABASE_URL}/rest/v1/ride_requests?id=eq.${requestId}`, {
    method: "PATCH",
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      status: "cancelled_by_user",
      cancelled_at: new Date().toISOString()
    })
  });
}
</script>

</body>
</html>
