<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>QR Taksi â€“ Yolcu</title>

  <style>
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#f5f6f7;
      font-family:system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .card{
      width:min(420px, 92vw);
      background:#fff;
      border-radius:18px;
      padding:22px;
      box-shadow:0 12px 30px rgba(0,0,0,.12);
      text-align:center;
    }
    h1{margin:0 0 6px;font-size:20px}
    .muted{color:#666;font-size:13px}
    .big{font-size:18px;font-weight:600;margin:16px 0}
    button{
      width:100%;
      padding:14px;
      border:0;
      border-radius:14px;
      font-size:16px;
      cursor:pointer;
    }
    button.primary{background:#111;color:#fff}
    button.danger{background:#e53935;color:#fff}
    button:disabled{opacity:.5;cursor:not-allowed}
    .spacer{height:12px}
    .status{margin-top:14px;font-size:14px}
  </style>
</head>
<body>

<div class="card">
  <h1>ðŸš• QR Taksi</h1>
  <div class="muted">BulunduÄŸun noktadan taksi Ã§aÄŸÄ±r</div>

  <div id="locationBox" class="big">Lokasyon: â€”</div>

  <button id="callBtn" class="primary" onclick="callTaxi()" disabled>
    Taksi Ã‡aÄŸÄ±r
  </button>

  <div class="spacer"></div>

  <button id="cancelBtn" class="danger" onclick="cancelCall()" disabled>
    Ä°ptal Et
  </button>

  <div id="status" class="status muted"></div>
</div>

<script>
  const SUPABASE_URL = "https://cpkefhmqwrpjrwyvudky.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa2VmaG1xd3JwanJ3eXZ1ZGt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4Nzc2NjQsImV4cCI6MjA4MTQ1MzY2NH0.HhODIa99Wic-xYXa9Scg-vj7t-dERDKwskF8shfZfQk";

  const params = new URLSearchParams(location.search);
  const locationId = params.get("location");

  const callBtn = document.getElementById("callBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const statusBox = document.getElementById("status");
  const locationBox = document.getElementById("locationBox");

  let rideId = null;

  if (!locationId) {
    locationBox.textContent = "Lokasyon bulunamadÄ±";
    statusBox.textContent = "QR kod geÃ§ersiz. LÃ¼tfen doÄŸru QR kodu tarat.";
  } else {
    locationBox.textContent = "Lokasyon: " + locationId;
    callBtn.disabled = false;
  }

  function headers() {
    return {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json"
    };
  }

  async function callTaxi() {
    callBtn.disabled = true;
    statusBox.textContent = "Taksi Ã§aÄŸrÄ±lÄ±yorâ€¦";

    const res = await fetch(
      `${SUPABASE_URL}/rest/v1/ride_requests`,
      {
        method: "POST",
        headers: headers(),
        body: JSON.stringify({
          location_id: locationId,     // ðŸ”’ NULL YOK
          status: "waiting"
        })
      }
    );

    if (!res.ok) {
      statusBox.textContent = "Bir hata oluÅŸtu.";
      callBtn.disabled = false;
      return;
    }

    const data = await res.json();
    rideId = data[0].id;

    statusBox.textContent = "Taksi Ã§aÄŸrÄ±ldÄ±. Bekleniyorâ€¦";
    cancelBtn.disabled = false;
  }

  async function cancelCall() {
    if (!rideId) return;

    cancelBtn.disabled = true;

    await fetch(
      `${SUPABASE_URL}/rest/v1/ride_requests?id=eq.${rideId}`,
      {
        method: "PATCH",
        headers: headers(),
        body: JSON.stringify({
          status: "cancelled_by_user"
        })
      }
    );

    statusBox.textContent = "Ã‡aÄŸrÄ± iptal edildi.";
  }
</script>

</body>
</html>
