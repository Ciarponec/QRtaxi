<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Taksi â€“ Taksici</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#111111" />
  <style>
    body{
      margin:0; font-family: Arial, sans-serif;
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:#f6f6f6;
    }
    .card{
      background:#fff; width:min(520px, 92vw);
      border-radius:16px; padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,0.12);
    }
    h1{ font-size:18px; margin:0 0 10px; }
    .muted{ color:#666; font-size:12px; line-height:1.4; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button{
      padding:10px 12px; border:0; border-radius:12px;
      background:#111; color:#fff; cursor:pointer;
    }
    button.secondary{ background:#eee; color:#111; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .pill{
      display:inline-block; padding:6px 10px; border-radius:999px;
      font-size:12px; background:#eee;
    }
    .section{ margin-top:14px; padding-top:14px; border-top:1px solid #eee; }
    .stops{ margin-top:8px; display:grid; gap:8px; }
    .stop{
      display:flex; gap:10px; align-items:center;
      padding:10px; border:1px solid #eee; border-radius:12px;
      background:#fafafa;
    }
    .warn{ background:#fff5e6; border:1px solid #ffd59a; padding:10px; border-radius:12px; }
    code{ background:#f1f1f1; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ðŸš• QR Taksi â€“ Taksici Bildirimleri</h1>
    <div class="muted">
      Bu sayfa bildirim izni alÄ±r ve seÃ§tiÄŸin duraklarÄ±n lokasyonlarÄ±ndan Ã§aÄŸrÄ± geldiÄŸinde telefonuna bildirim dÃ¼ÅŸer.
      <br><br>
      <b>iPhone:</b> Bildirim iÃ§in bu sayfayÄ± <b>Ana Ekrana Ekle</b>men gerekir (iOS 16.4+).
    </div>

    <div class="section">
      <div class="row">
        <span id="statusPill" class="pill">Durum: bilinmiyor</span>
        <span id="platformPill" class="pill"></span>
      </div>

      <div id="iosHint" class="warn" style="display:none; margin-top:10px;">
        <b>iPhone tespiti:</b> Bildirim iÃ§in ÅŸu adÄ±mlarÄ± yap:
        <ol class="muted" style="margin:8px 0 0 18px;">
          <li>Safariâ€™de <b>PaylaÅŸ</b> (kare + ok) butonuna bas</li>
          <li><b>Ana Ekrana Ekle</b> seÃ§</li>
          <li>Ana ekrandan aÃ§Ä±p <b>Bildirimlere izin ver</b></li>
        </ol>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="btnEnable" onclick="enableNotifications()">Bildirimlere izin ver</button>
        <button class="secondary" onclick="refresh()">Yenile</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnMute" class="secondary" onclick="setActive(false)" disabled>ðŸ”• Mola (bildirim kapat)</button>
        <button id="btnUnmute" onclick="setActive(true)" disabled>ðŸ”” Bildirimleri aÃ§</button>
      </div>
    </div>

    <div class="section">
      <b>Durak seÃ§imi (Ã§oklu)</b>
      <div class="muted">SeÃ§tiÄŸin duraklara baÄŸlÄ± lokasyonlardan bildirim alÄ±rsÄ±n.</div>
      <div id="stopsBox" class="stops"></div>
      <div class="row" style="margin-top:10px;">
        <button id="btnSaveStops" onclick="saveStops()" disabled>DuraklarÄ± Kaydet</button>
      </div>
    </div>

    <div class="section">
      <div class="muted">
        Teknik not: Bu cihaz kimliÄŸi: <code id="clientIdBox"></code>
      </div>
    </div>
  </div>

<script>
  const SUPABASE_URL = "https://cpkefhmqwrpjrwyvudky.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa2VmaG1xd3JwanJ3eXZ1ZGt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4Nzc2NjQsImV4cCI6MjA4MTQ1MzY2NH0.HhODIa99Wic-xYXa9Scg-vj7t-dERDKwskF8shfZfQk";

  // âœ… BURAYA KENDÄ° VAPID PUBLIC KEYâ€™Ä°NÄ° KOYACAKSIN
  const VAPID_PUBLIC_KEY = "PASTE_YOUR_VAPID_PUBLIC_KEY_HERE";

  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;

  let clientId = localStorage.getItem("qrtaxi_client_id");
  if (!clientId) {
    clientId = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random());
    localStorage.setItem("qrtaxi_client_id", clientId);
  }
  document.getElementById("clientIdBox").textContent = clientId;

  const platformPill = document.getElementById("platformPill");
  platformPill.textContent = isIOS ? "Platform: iPhone/iOS" : "Platform: Android/DiÄŸer";

  if (isIOS && !isStandalone) {
    document.getElementById("iosHint").style.display = "block";
  }

  function headers(json=false){
    const h = { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` };
    if (json) h["Content-Type"] = "application/json";
    return h;
  }

  function urlBase64ToUint8Array(base64String) {
    const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
    const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
    const rawData = atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
    return outputArray;
  }

  function setStatus(text){
    document.getElementById("statusPill").textContent = "Durum: " + text;
  }

  async function refresh(){
    await loadStops();
    await loadMySubscription();
    await updatePermissionUI();
  }

  async function updatePermissionUI(){
    if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
      setStatus("Bu tarayÄ±cÄ± Push desteklemiyor");
      document.getElementById("btnEnable").disabled = true;
      return;
    }

    const perm = Notification.permission;
    if (perm === "granted") {
      setStatus("Bildirim izni verildi");
      document.getElementById("btnEnable").disabled = true;
      document.getElementById("btnSaveStops").disabled = false;
    } else if (perm === "denied") {
      setStatus("Bildirim izni reddedildi");
      document.getElementById("btnEnable").disabled = true;
      document.getElementById("btnSaveStops").disabled = true;
    } else {
      setStatus("Bildirim izni bekliyor");
      document.getElementById("btnEnable").disabled = false;
      document.getElementById("btnSaveStops").disabled = true;
    }
  }

  async function enableNotifications(){
    if (isIOS && !isStandalone) {
      alert("iPhoneâ€™da bildirim iÃ§in Ã¶nce Ana Ekrana Ekle yapÄ±p oradan aÃ§malÄ±sÄ±n.");
      return;
    }

    const perm = await Notification.requestPermission();
    if (perm !== "granted") {
      await updatePermissionUI();
      return;
    }

    const reg = await navigator.serviceWorker.register("./service-worker.js", { scope: "./" });

    const sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
    });

    await upsertSubscription(sub);

    await updatePermissionUI();
    await loadMySubscription();
    alert("Bildirimler aktif. Åžimdi duraklarÄ± seÃ§ip kaydet.");
  }

  async function upsertSubscription(sub){
    const data = sub.toJSON();

    // upsert by endpoint (unique)
    const payload = {
      client_id: clientId,
      endpoint: data.endpoint,
      p256dh: data.keys.p256dh,
      auth: data.keys.auth,
      is_active: true,
      stop_ids: []
    };

    const r = await fetch(`${SUPABASE_URL}/rest/v1/taxi_push_subscriptions?on_conflict=endpoint`, {
      method: "POST",
      headers: { ...headers(true), Prefer: "resolution=merge-duplicates,return=representation" },
      body: JSON.stringify(payload)
    });

    if (!r.ok) {
      const t = await r.text();
      alert("Abonelik kaydÄ± baÅŸarÄ±sÄ±z: " + t);
    }
  }

  async function loadMySubscription(){
    // client_id ile Ã§ekiyoruz
    const r = await fetch(`${SUPABASE_URL}/rest/v1/taxi_push_subscriptions?client_id=eq.${encodeURIComponent(clientId)}&select=*`, {
      headers: headers(false)
    });
    const rows = await r.json();
    const row = rows[0];

    const btnMute = document.getElementById("btnMute");
    const btnUnmute = document.getElementById("btnUnmute");

    if (!row) {
      btnMute.disabled = true;
      btnUnmute.disabled = true;
      return;
    }

    if (row.is_active) {
      btnMute.disabled = false;
      btnUnmute.disabled = true;
    } else {
      btnMute.disabled = true;
      btnUnmute.disabled = false;
    }

    // stop_ids seÃ§imini UI'ye yansÄ±t
    const selected = new Set((row.stop_ids || []).map(String));
    document.querySelectorAll("input[data-stop]").forEach(chk => {
      chk.checked = selected.has(chk.value);
    });
  }

  async function setActive(active){
    const r = await fetch(`${SUPABASE_URL}/rest/v1/taxi_push_subscriptions?client_id=eq.${encodeURIComponent(clientId)}`, {
      method: "PATCH",
      headers: headers(true),
      body: JSON.stringify({ is_active: active, last_seen_at: new Date().toISOString() })
    });
    if (!r.ok) {
      alert("GÃ¼ncellenemedi (mola): " + await r.text());
      return;
    }
    await loadMySubscription();
  }

  async function loadStops(){
    const r = await fetch(`${SUPABASE_URL}/rest/v1/taxi_stops?is_active=neq.false&select=id,name&order=created_at.asc`, {
      headers: headers(false)
    });
    const rows = await r.json();

    const box = document.getElementById("stopsBox");
    box.innerHTML = "";

    rows.forEach(s => {
      const div = document.createElement("div");
      div.className = "stop";
      div.innerHTML = `
        <input type="checkbox" data-stop="1" value="${s.id}" id="stop_${s.id}">
        <label for="stop_${s.id}"><b>${s.name}</b></label>
      `;
      box.appendChild(div);
    });
  }

  async function saveStops(){
    // seÃ§ili duraklar
    const selected = Array.from(document.querySelectorAll("input[data-stop]:checked")).map(x => x.value);

    const r = await fetch(`${SUPABASE_URL}/rest/v1/taxi_push_subscriptions?client_id=eq.${encodeURIComponent(clientId)}`, {
      method: "PATCH",
      headers: headers(true),
      body: JSON.stringify({ stop_ids: selected, last_seen_at: new Date().toISOString() })
    });

    if (!r.ok) {
      alert("Duraklar kaydedilemedi: " + await r.text());
      return;
    }
    alert("Durak seÃ§imi kaydedildi âœ…");
  }

  // Boot
  (async () => {
    await navigator.serviceWorker.register("./service-worker.js", { scope: "./" }).catch(()=>{});
    await refresh();
  })();
</script>
</body>
</html>
